<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/versionUpdate.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core/versionUpdate.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * Copyright 2024 The Ray Optics Simulation authors and contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import * as sceneObjs from './sceneObjs.js';
import Scene from './Scene.js';

const scene_update = {
  "rayDensity_light": "rayModeDensity",
  "rayDensity_images": "imageModeDensity",
  "grid": "snapToGrid",
  "lockobjs": "lockObjs",
  "colorMode": "simulateColors",
  "symbolicGrin": "symbolicBodyMerging"
}

const mode_update = {
  "light": "rays",
  "extended_light": "extended"
}

const obj_update = {
  "laser": {
    "type": "SingleRay",
    "p": "brightness"
  },
  "parallel": {
    "type": "Beam",
    "p": "brightness",
    "divergence": "emisAngle"
  },
  "radiant": {
    "type": "PointSource",
    "p": "brightness"
  },
  "led": {
    "type": "AngleSource",
    "p": "emisAngle"
  },
  "mirror": {
    "type": "Mirror",
    "isDichroic": "filter",
    "isDichroicFilter": "invert"
  },
  "arcmirror": {
    "type": "ArcMirror",
    "isDichroic": "filter",
    "isDichroicFilter": "invert"
  },
  "parabolicmirror": {
    "type": "ParabolicMirror",
    "isDichroic": "filter",
    "isDichroicFilter": "invert"
  },
  "curvedmirror": {
    "type": "CustomMirror",
    "p": "eqn",
    "isDichroic": "filter",
    "isDichroicFilter": "invert"
  },
  "idealmirror": {
    "type": "IdealMirror",
    "p": "focalLength",
    "isDichroic": "filter",
    "isDichroicFilter": "invert"
  },
  "beamsplitter": {
    "type": "BeamSplitter",
    "p": "transRatio",
    "isDichroic": "filter",
    "isDichroicFilter": "invert"
  },
  "halfplane": {
    "type": "PlaneGlass",
    "p": "refIndex",
    "cauchyCoeff": "cauchyB"
  },
  "circlelens": {
    "type": "CircleGlass",
    "p": "refIndex",
    "cauchyCoeff": "cauchyB"
  },
  "refractor": {
    "type": "Glass",
    "p": "refIndex",
    "cauchyCoeff": "cauchyB"
  },
  "curvedglass": {
    "type": "CustomGlass",
    "p": "refIndex",
    "cauchyCoeff": "cauchyB"
  },
  "lens": {
    "type": "IdealLens",
    "p": "focalLength"
  },
  "sphericallens": {
    "type": "SphericalLens",
    "p": "refIndex",
    "cauchyCoeff": "cauchyB",
    "definedBy": "defBy"
  },
  "grin_circlelens": {
    "type": "CircleGrinGlass",
    "p_tex": "refIndexFn",
    "step_size": "stepSize",
    "eps": "intersectTol"
  },
  "grin_refractor": {
    "type": "GrinGlass",
    "p_tex": "refIndexFn",
    "step_size": "stepSize",
    "eps": "intersectTol"
  },
  "blackline": {
    "type": "Blocker",
    "isDichroic": "filter",
    "isDichroicFilter": "invert"
  },
  "blackcircle": {
    "type": "CircleBlocker",
    "isDichroic": "filter",
    "isDichroicFilter": "invert"
  },
  "aperture": {
    "type": "Aperture",
    "isDichroic": "filter",
    "isDichroicFilter": "invert"
  },
  "diffractiongrating": {
    "type": "DiffractionGrating",
    "line_density": "lineDensity",
    "slit_ratio": "slitRatio"
  },
  "ruler": {
    "type": "Ruler",
    "p": "scaleInterval"
  },
  "protractor": {
    "type": "Protractor"
  },
  "power": {
    "type": "Detector",
    "irradianceMap": "irradMap"
  },
  "text": {
    "type": "TextLabel",
    "p": "text",
    "fontName": "font",
    "fontAlignment": "alignment",
    "fontSmallCaps": "smallCaps",
    "fontAngle": "angle"
  },
  "line": {
    "type": "LineArrow",
    "arrow1": "arrow",
    "arrow2": "backArrow"
  },
  "drawing": {
    "type": "Drawing",
    "points": "strokes"
  },
  "handle": {
    "type": "Handle"
  },
  "cropbox": {
    "type": "CropBox"
  }
}

/**
 * Update the scene JSON data to the latest version.
 * @param {Object} jsonData 
 * @returns {Object} The updated JSON data.
 */
export function versionUpdate(jsonData) {
  if (!jsonData.version) {
    // Chrome App version 1.0 and earlier (2011/11/1--2014/6/29)

    let str1 = JSON.stringify(jsonData).replace(/"point"|"xxa"|"aH"/g, '1').replace(/"circle"|"xxf"/g, '5').replace(/"k"/g, '"objs"').replace(/"L"/g, '"p1"').replace(/"G"/g, '"p2"').replace(/"F"/g, '"p3"').replace(/"bA"/g, '"exist"').replace(/"aa"/g, '"parallel"').replace(/"ba"/g, '"mirror"').replace(/"bv"/g, '"lens"').replace(/"av"/g, '"notDone"').replace(/"bP"/g, '"lightAlpha"').replace(/"ab"|"observed_light"|"observed_images"/g, '"observer"');
    jsonData = JSON.parse(str1);
    if (!jsonData.objs) {
      jsonData = { objs: jsonData };
    }
    if (!jsonData.mode) {
      jsonData.mode = 'light';
    }
    if (!jsonData.rayDensity_light) {
      jsonData.rayDensity_light = 1;
    }
    if (!jsonData.rayDensity_images) {
      jsonData.rayDensity_images = 1;
    }
    if (!jsonData.scale) {
      jsonData.scale = 1;
    }
    jsonData.version = 1;
  }

  if (jsonData.version == 1) {
    // Chrome App versions 1.1 to 1.2 (2014/6/30--2015/3/2)
    jsonData.origin = { x: 0, y: 0 };
    jsonData.version = 2;
  }

  if (jsonData.version == 2) {
    // Chrome App version 2.0 and web app versions 2.x to 4.x (2015/3/3--2024/5/20)

    // Update scene properties
    for (let key in scene_update) {
      if (jsonData[key] !== undefined) {
        jsonData[scene_update[key]] = jsonData[key];
        delete jsonData[key];
      }
    }

    // Update mode
    if (jsonData.mode in mode_update) {
      jsonData.mode = mode_update[jsonData.mode];
    }

    // Update object types and their properties
    jsonData.objs = jsonData.objs.map(objData => {
      if (objData.type in obj_update) {
        for (let key in obj_update[objData.type]) {
          if (key !== "type" &amp;&amp; objData[key] !== undefined) {
            objData[obj_update[objData.type][key]] = objData[key];
            delete objData[key];
          }
        }
        objData.type = obj_update[objData.type].type;
      }
      return objData;
    });

    // Update deep properties
    function updateProperties(obj) {
      if (typeof obj === 'object' &amp;&amp; obj !== null) {
        if (obj.exist !== undefined) {
          delete obj.exist;
        }
        if (typeof obj.type === 'number') {
          delete obj.type;
        }
        if (obj.byHandle !== undefined) {
          delete obj.byHandle;
        }
        if (obj.targetObj_index !== undefined) {
          obj.targetObjIndex = obj.targetObj_index;
          delete obj.targetObj_index;
        }
        if (obj.mousePart !== undefined) {
          obj.dragContext = obj.mousePart;
          delete obj.mousePart;
        }

        for (let key in obj) {
          updateProperties(obj[key]);
        }
      }
    }
    updateProperties(jsonData);

    // Remove all unknown scene keys
    const knownKeys = ['version', 'name', 'objs', 'backgroundImage', ...Object.keys(Scene.serializableDefaults)];
    for (let key in jsonData) {
      if (!knownKeys.includes(key)) {
        delete jsonData[key];
      }
    }

    // Remove all objects with unknown type
    jsonData.objs = jsonData.objs.filter(objData => {
      return objData.type in sceneObjs;
    });

    // Remove all object properties not in the serializableDefaults
    jsonData.objs = jsonData.objs.map(objData => {
      const knownKeys = ['type', ...Object.keys(sceneObjs[objData.type].serializableDefaults)];
      for (let key in objData) {
        if (!knownKeys.includes(key)) {
          delete objData[key];
        }
      }
      return objData;
    });

    // Data version number 3 and 4 do not exist since app version 3.x and 4.x do not change the data format. The next app release will be called version 5.0 so the data version number is updated to 5 to match the app version. Starting from this version, the data version number will always match the app version major number.
    jsonData.version = 5;
  }

  return jsonData;
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-App.html">App</a></li><li><a href="module-CanvasContainer.html">CanvasContainer</a></li><li><a href="module-ColorModeModal.html">ColorModeModal</a></li><li><a href="module-ColorPicker.html">ColorPicker</a></li><li><a href="module-DashPicker.html">DashPicker</a></li><li><a href="module-FileBar.html">FileBar</a></li><li><a href="module-FillControl.html">FillControl</a></li><li><a href="module-FontPicker.html">FontPicker</a></li><li><a href="module-Footer.html">Footer</a></li><li><a href="module-LanguageModal.html">LanguageModal</a></li><li><a href="module-LayoutAidsBar.html">LayoutAidsBar</a></li><li><a href="module-ModuleModal.html">ModuleModal</a></li><li><a href="module-ModuleTools.html">ModuleTools</a></li><li><a href="module-MoreToolsCollapsible.html">MoreToolsCollapsible</a></li><li><a href="module-NumberControl.html">NumberControl</a></li><li><a href="module-ObjBar.html">ObjBar</a></li><li><a href="module-PointControl.html">PointControl</a></li><li><a href="module-PopupSelectControl.html">PopupSelectControl</a></li><li><a href="module-RayDensityBar.html">RayDensityBar</a></li><li><a href="module-SaveModal.html">SaveModal</a></li><li><a href="module-SettingsBar.html">SettingsBar</a></li><li><a href="module-SettingsList.html">SettingsList</a></li><li><a href="module-SettingsWarning.html">SettingsWarning</a></li><li><a href="module-Sidebar.html">Sidebar</a></li><li><a href="module-SimulatorControls.html">SimulatorControls</a></li><li><a href="module-SizePicker.html">SizePicker</a></li><li><a href="module-StatusArea.html">StatusArea</a></li><li><a href="module-StrokeControl.html">StrokeControl</a></li><li><a href="module-TextControl.html">TextControl</a></li><li><a href="module-TextInput.html">TextInput</a></li><li><a href="module-ThemeModal.html">ThemeModal</a></li><li><a href="module-ThemeOptionsList.html">ThemeOptionsList</a></li><li><a href="module-ToggleControl.html">ToggleControl</a></li><li><a href="module-ToolItem.html">ToolItem</a></li><li><a href="module-Toolbar.html">Toolbar</a></li><li><a href="module-ToolsBar.html">ToolsBar</a></li><li><a href="module-ToolsCategory.html">ToolsCategory</a></li><li><a href="module-ToolsList.html">ToolsList</a></li><li><a href="module-ViewBar.html">ViewBar</a></li><li><a href="module-WelcomeMessage.html">WelcomeMessage</a></li><li><a href="module-ZoomControl.html">ZoomControl</a></li><li><a href="module-app_.html">app</a></li></ul><h3>Namespaces</h3><ul><li><a href="geometry.html">geometry</a></li><li><a href="sceneObjs.html">sceneObjs</a></li></ul><h3>Classes</h3><ul><li><a href="BaseFilter.html">BaseFilter</a></li><li><a href="BaseGlass.html">BaseGlass</a></li><li><a href="BaseGrinGlass.html">BaseGrinGlass</a></li><li><a href="BaseSceneObj.html">BaseSceneObj</a></li><li><a href="CanvasRenderer.html">CanvasRenderer</a></li><li><a href="Editor.html">Editor</a></li><li><a href="FloatColorRenderer.html">FloatColorRenderer</a></li><li><a href="JsonEditorService.html">JsonEditorService</a></li><li><a href="Mouse.html">Mouse</a></li><li><a href="ObjBar.html">ObjBar</a></li><li><a href="Scene.html">Scene</a></li><li><a href="Simulator.html">Simulator</a></li><li><a href="sceneObjs.AngleSource.html">AngleSource</a></li><li><a href="sceneObjs.Aperture.html">Aperture</a></li><li><a href="sceneObjs.ArcMirror.html">ArcMirror</a></li><li><a href="sceneObjs.BaseCustomSurface.html">BaseCustomSurface</a></li><li><a href="sceneObjs.Beam.html">Beam</a></li><li><a href="sceneObjs.BeamSplitter.html">BeamSplitter</a></li><li><a href="sceneObjs.Blocker.html">Blocker</a></li><li><a href="sceneObjs.CircleBlocker.html">CircleBlocker</a></li><li><a href="sceneObjs.CircleGlass.html">CircleGlass</a></li><li><a href="sceneObjs.CircleGrinGlass.html">CircleGrinGlass</a></li><li><a href="sceneObjs.ConcaveDiffractionGrating.html">ConcaveDiffractionGrating</a></li><li><a href="sceneObjs.CropBox.html">CropBox</a></li><li><a href="sceneObjs.CurveGlass.html">CurveGlass</a></li><li><a href="sceneObjs.CurveGrinGlass.html">CurveGrinGlass</a></li><li><a href="sceneObjs.CustomArcSurface.html">CustomArcSurface</a></li><li><a href="sceneObjs.CustomGlass.html">CustomGlass</a></li><li><a href="sceneObjs.CustomMirror.html">CustomMirror</a></li><li><a href="sceneObjs.CustomParamSurface.html">CustomParamSurface</a></li><li><a href="sceneObjs.CustomSurface.html">CustomSurface</a></li><li><a href="sceneObjs.Detector.html">Detector</a></li><li><a href="sceneObjs.DiffractionGrating.html">DiffractionGrating</a></li><li><a href="sceneObjs.Drawing.html">Drawing</a></li><li><a href="sceneObjs.Glass.html">Glass</a></li><li><a href="sceneObjs.GrinGlass.html">GrinGlass</a></li><li><a href="sceneObjs.Handle.html">Handle</a></li><li><a href="sceneObjs.IdealLens.html">IdealLens</a></li><li><a href="sceneObjs.IdealMirror.html">IdealMirror</a></li><li><a href="sceneObjs.LineArrow.html">LineArrow</a></li><li><a href="sceneObjs.Mirror.html">Mirror</a></li><li><a href="sceneObjs.ModuleObj.html">ModuleObj</a></li><li><a href="sceneObjs.ParabolicMirror.html">ParabolicMirror</a></li><li><a href="sceneObjs.ParamGlass.html">ParamGlass</a></li><li><a href="sceneObjs.ParamGrinGlass.html">ParamGrinGlass</a></li><li><a href="sceneObjs.ParamMirror.html">ParamMirror</a></li><li><a href="sceneObjs.PlaneGlass.html">PlaneGlass</a></li><li><a href="sceneObjs.PointSource.html">PointSource</a></li><li><a href="sceneObjs.Protractor.html">Protractor</a></li><li><a href="sceneObjs.Ruler.html">Ruler</a></li><li><a href="sceneObjs.SingleRay.html">SingleRay</a></li><li><a href="sceneObjs.SphericalLens.html">SphericalLens</a></li><li><a href="sceneObjs.TextLabel.html">TextLabel</a></li></ul><h3>Events</h3><ul><li><a href="Editor.html#event:mouseCoordinateChange">mouseCoordinateChange</a></li><li><a href="Editor.html#event:newAction">newAction</a></li><li><a href="Editor.html#event:newUndoPoint">newUndoPoint</a></li><li><a href="Editor.html#event:positioningEnd">positioningEnd</a></li><li><a href="Editor.html#event:positioningStart">positioningStart</a></li><li><a href="Editor.html#event:redo">redo</a></li><li><a href="Editor.html#event:requestPositioningComfirm">requestPositioningComfirm</a></li><li><a href="Editor.html#event:scaleChange">scaleChange</a></li><li><a href="Editor.html#event:sceneLoaded">sceneLoaded</a></li><li><a href="Editor.html#event:selectionChange">selectionChange</a></li><li><a href="Editor.html#event:undo">undo</a></li><li><a href="ObjBar.html#event:edit">edit</a></li><li><a href="ObjBar.html#event:editEnd">editEnd</a></li><li><a href="ObjBar.html#event:requestUpdate">requestUpdate</a></li><li><a href="ObjBar.html#event:showAdvancedEnabled">showAdvancedEnabled</a></li><li><a href="Simulator.html#event:lightLayerSyncChange">lightLayerSyncChange</a></li><li><a href="Simulator.html#event:simulationComplete">simulationComplete</a></li><li><a href="Simulator.html#event:simulationPause">simulationPause</a></li><li><a href="Simulator.html#event:simulationStart">simulationStart</a></li><li><a href="Simulator.html#event:simulationStop">simulationStop</a></li><li><a href="Simulator.html#event:update">update</a></li><li><a href="global.html#event:requestUpdateErrorAndWarning">requestUpdateErrorAndWarning</a></li><li><a href="global.html#event:webglContextLost">webglContextLost</a></li></ul><h3>Global</h3><ul><li><a href="global.html#CircleObjMixin">CircleObjMixin</a></li><li><a href="global.html#DATA_VERSION">DATA_VERSION</a></li><li><a href="global.html#LineObjMixin">LineObjMixin</a></li><li><a href="global.html#ParamCurveObjMixin">ParamCurveObjMixin</a></li><li><a href="global.html#checkRayIntersectsShape">checkRayIntersectsShape</a></li><li><a href="global.html#countIntersections">countIntersections</a></li><li><a href="global.html#deepEqual">deepEqual</a></li><li><a href="global.html#distancePointToSegment">distancePointToSegment</a></li><li><a href="global.html#drawPath">drawPath</a></li><li><a href="global.html#extractNonDefaults">extractNonDefaults</a></li><li><a href="global.html#getRayIntersections">getRayIntersections</a></li><li><a href="global.html#initPath">initPath</a></li><li><a href="global.html#isClosed">isClosed</a></li><li><a href="global.html#isInside">isInside</a></li><li><a href="global.html#isOnBoundary">isOnBoundary</a></li><li><a href="global.html#isOutside">isOutside</a></li><li><a href="global.html#isPositivelyOriented">isPositivelyOriented</a></li><li><a href="global.html#mergeWithDefaults">mergeWithDefaults</a></li><li><a href="global.html#populateObjBarShape">populateObjBarShape</a></li><li><a href="global.html#setViewportSize">setViewportSize</a></li><li><a href="global.html#toJSON">toJSON</a></li><li><a href="global.html#usePreferencesStore">usePreferencesStore</a></li><li><a href="global.html#useSceneStore">useSceneStore</a></li><li><a href="global.html#useStatus">useStatus</a></li><li><a href="global.html#useStatusStore">useStatusStore</a></li><li><a href="global.html#useThemeStore">useThemeStore</a></li><li><a href="global.html#vTooltipPopover">vTooltipPopover</a></li><li><a href="global.html#validateNestedKeys">validateNestedKeys</a></li><li><a href="global.html#versionUpdate">versionUpdate</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
