<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/sceneObjs/special/CropBox.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core/sceneObjs/special/CropBox.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * Copyright 2024 The Ray Optics Simulation authors and contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import BaseSceneObj from '../BaseSceneObj.js';
import geometry from '../../geometry.js';
import i18next from 'i18next';

/**
 * The crop box
 * 
 * File -> Export as PNG/SVG
 * @class
 * @extends BaseSceneObj
 * @memberof sceneObjs
 * @property {Point} p1 - The top left corner of the crop box.
 * @property {Point} p2 - The top right corner of the crop box.
 * @property {Point} p3 - The bottom left corner of the crop box.
 * @property {Point} p4 - The bottom right corner of the crop box.
 * @property {string} format - The format of the image to be exported.
 * @property {number} width - The width of the image to be exported. Not effective when the format is 'svg'.
 * @property {number} rayCountLimit - The maximum number of rays to be traced. This is to avoid infinite loop. If not set, the default value is determined by the simulator and depends on `format`.
 * @property {boolean} transparent - Whether the image should have a transparent background.
 */
class CropBox extends BaseSceneObj {
  static type = 'CropBox';
  static serializableDefaults = {
    p1: null,
    p4: null,
    format: 'png',
    width: 1920,
    rayCountLimit: null,
    transparent: false
  };

  constructor(scene, jsonObj) {
    super(scene, jsonObj);

    // Infer `p2` and `p3` from `p1` and `p4`.
    if (this.p1 &amp;&amp; this.p4) {
      this.p2 = geometry.point(this.p4.x, this.p1.y);
      this.p3 = geometry.point(this.p1.x, this.p4.y);
    }
  }

  populateObjBar(objBar) {
    objBar.setTitle(i18next.t('simulator:sceneObjs.CropBox.title'));

    var width = geometry.distance(this.p1, this.p2);
    var height = geometry.distance(this.p1, this.p3);

    objBar.createNumber(i18next.t('simulator:sceneObjs.CropBox.cropBoxSize'), 0, 1000, 1, width, function (obj, value) {
      obj.p2 = geometry.point(obj.p1.x + 1 * value, obj.p2.y);
      obj.p4 = geometry.point(obj.p3.x + 1 * value, obj.p4.y);
    }, null, true);
    objBar.createNumber('x', 0, 1000, 1, height, function (obj, value) {
      obj.p3 = geometry.point(obj.p3.x, obj.p1.y + 1 * value);
      obj.p4 = geometry.point(obj.p4.x, obj.p2.y + 1 * value);
    }, null, true);

    objBar.createDropdown(i18next.t('simulator:sceneObjs.CropBox.format'), this.format, {
      'png': 'PNG',
      'svg': 'SVG'
    }, function (obj, value) {
      obj.format = value;
    }, null, true);

    if (this.format != 'svg') {
      objBar.createNumber(i18next.t('simulator:sceneObjs.CropBox.width'), 0, 1000, 1, this.width, function (obj, value) {
        obj.width = 1 * value;
      }, null, true);
    }

    const rayCountLimit = this.rayCountLimit || (this.format === 'svg' ? 1e4 : 1e7);

    if (objBar.showAdvanced(!this.arePropertiesDefault(['rayCountLimit', 'transparent']))) {
      objBar.createNumber(i18next.t('simulator:sceneObjs.CropBox.rayCountLimit'), 0, 1e7, 1, rayCountLimit, function (obj, value) {
        obj.rayCountLimit = value;
        if (obj.scene.simulator.processedRayCount > obj.rayCountLimit) {
          obj.warning = i18next.t('simulator:sceneObjs.CropBox.rayCountWarning');
        } else {
          obj.warning = null;
        }
      }, null, true);
      objBar.createBoolean(i18next.t('simulator:sceneObjs.CropBox.transparent'), this.transparent, function (obj, value) {
        obj.transparent = value;
      });
    }

    const self = this;
    objBar.createButton(i18next.t('simulator:common.saveButton'), function (obj) {
      self.warning = null;
      self.scene.editor.confirmCrop(obj);
    });
    objBar.createButton(i18next.t('simulator:common.cancelButton'), function (obj) {
      self.warning = null;
      self.scene.editor.cancelCrop();
    });

    this.warning = null;

    if (this.format === 'svg') {
      if (this.scene.simulateColors || this.scene.colorMode !== 'default') {
        this.warning = i18next.t('simulator:sceneObjs.CropBox.svgWarning');
      }

      // Check if there are any objects with `refIndex &lt; 1`
      for (var obj of this.scene.opticalObjs) {
        if (obj.refIndex &amp;&amp; obj.refIndex &lt; 1) {
          this.warning = i18next.t('simulator:sceneObjs.CropBox.svgWarning');
          break;
        }
      }
    }

    if (this.scene.simulator.processedRayCount > rayCountLimit) {
      this.warning = i18next.t('simulator:sceneObjs.CropBox.rayCountWarning');
    }
  }

  draw(canvasRenderer, isAboveLight, isHovered) {
    if (!(this.scene.editor &amp;&amp; this.scene.editor.isInCropMode)) return;

    const ctx = canvasRenderer.ctx;
    const ls = canvasRenderer.lengthScale;

    ctx.strokeStyle = isHovered ? this.scene.highlightColorCss : canvasRenderer.rgbaToCssColor(this.scene.theme.decoration.color);
    ctx.lineWidth = 1 * ls;
    ctx.beginPath();
    ctx.moveTo(this.p1.x, this.p1.y);
    ctx.lineTo(this.p2.x, this.p2.y);
    ctx.lineTo(this.p4.x, this.p4.y);
    ctx.lineTo(this.p3.x, this.p3.y);
    ctx.lineTo(this.p1.x, this.p1.y);
    ctx.stroke();
    ctx.fillStyle = isHovered ? this.scene.highlightColorCss : canvasRenderer.rgbaToCssColor(this.scene.theme.decoration.color);
    ctx.beginPath();
    ctx.arc(this.p1.x, this.p1.y, 5 * ls, 0, 2 * Math.PI);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(this.p2.x, this.p2.y, 5 * ls, 0, 2 * Math.PI);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(this.p3.x, this.p3.y, 5 * ls, 0, 2 * Math.PI);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(this.p4.x, this.p4.y, 5 * ls, 0, 2 * Math.PI);
    ctx.fill();
  }

  move(diffX, diffY) {
    this.p1.x += diffX;
    this.p1.y += diffY;
    this.p2.x += diffX;
    this.p2.y += diffY;
    this.p3.x += diffX;
    this.p3.y += diffY;
    this.p4.x += diffX;
    this.p4.y += diffY;
    return true;
  }
  
  scale(scale, center = null) {
    // Use the center of the crop box if none provided
    center = center || this.getDefaultCenter();
    
    // Scale the points relative to the center
    this.p1.x = center.x + (this.p1.x - center.x) * scale;
    this.p1.y = center.y + (this.p1.y - center.y) * scale;
    
    this.p2.x = center.x + (this.p2.x - center.x) * scale;
    this.p2.y = center.y + (this.p2.y - center.y) * scale;
    
    this.p3.x = center.x + (this.p3.x - center.x) * scale;
    this.p3.y = center.y + (this.p3.y - center.y) * scale;
    
    this.p4.x = center.x + (this.p4.x - center.x) * scale;
    this.p4.y = center.y + (this.p4.y - center.y) * scale;
    
    return true;
  }
  
  getDefaultCenter() {
    // Return the center of the crop box
    return {
      x: (this.p1.x + this.p2.x + this.p3.x + this.p4.x) / 4,
      y: (this.p1.y + this.p2.y + this.p3.y + this.p4.y) / 4
    };
  }

  checkMouseOver(mouse) {
    if (!(this.scene.editor &amp;&amp; this.scene.editor.isInCropMode)) return false;
    if (mouse.isOnPoint(this.p1)) {
      return { part: 1, targetPoint: geometry.point(this.p1.x, this.p1.y), cursor: 'nwse-resize', requiresObjBarUpdate: true };
    }
    if (mouse.isOnPoint(this.p2)) {
      return { part: 2, targetPoint: geometry.point(this.p2.x, this.p2.y), cursor: 'nesw-resize', requiresObjBarUpdate: true };
    }
    if (mouse.isOnPoint(this.p3)) {
      return { part: 3, targetPoint: geometry.point(this.p3.x, this.p3.y), cursor: 'nesw-resize', requiresObjBarUpdate: true };
    }
    if (mouse.isOnPoint(this.p4)) {
      return { part: 4, targetPoint: geometry.point(this.p4.x, this.p4.y), cursor: 'nwse-resize', requiresObjBarUpdate: true };
    }
    if (mouse.isOnSegment(geometry.line(this.p1, this.p2))) {
      return { part: 5, cursor: 'ns-resize', requiresObjBarUpdate: true };
    }
    if (mouse.isOnSegment(geometry.line(this.p2, this.p4))) {
      return { part: 6, cursor: 'ew-resize', requiresObjBarUpdate: true };
    }
    if (mouse.isOnSegment(geometry.line(this.p3, this.p4))) {
      return { part: 7, cursor: 'ns-resize', requiresObjBarUpdate: true };
    }
    if (mouse.isOnSegment(geometry.line(this.p1, this.p3))) {
      return { part: 8, cursor: 'ew-resize', requiresObjBarUpdate: true };
    }
    const mousePos = mouse.getPosSnappedToGrid();
    if (this.p1.x &lt; mousePos.x &amp;&amp; mousePos.x &lt; this.p2.x &amp;&amp; this.p1.y &lt; mousePos.y &amp;&amp; mousePos.y &lt; this.p3.y) {
      return { part: 0, mousePos0: mousePos, mousePos1: mousePos, snapContext: {} };
    }
  }

  onDrag(mouse, dragContext, ctrl, shift) {
    const mousePos = mouse.getPosSnappedToGrid();
    if (dragContext.part == 1) {
      this.p1.x = mousePos.x;
      this.p1.y = mousePos.y;
      this.p2.y = mousePos.y;
      this.p3.x = mousePos.x;
    } else if (dragContext.part == 2) {
      this.p2.x = mousePos.x;
      this.p2.y = mousePos.y;
      this.p1.y = mousePos.y;
      this.p4.x = mousePos.x;
    } else if (dragContext.part == 3) {
      this.p3.x = mousePos.x;
      this.p3.y = mousePos.y;
      this.p1.x = mousePos.x;
      this.p4.y = mousePos.y;
    } else if (dragContext.part == 4) {
      this.p4.x = mousePos.x;
      this.p4.y = mousePos.y;
      this.p2.x = mousePos.x;
      this.p3.y = mousePos.y;
    } else if (dragContext.part == 5) {
      this.p1.y = mousePos.y;
      this.p2.y = mousePos.y;
    } else if (dragContext.part == 6) {
      this.p2.x = mousePos.x;
      this.p4.x = mousePos.x;
    } else if (dragContext.part == 7) {
      this.p3.y = mousePos.y;
      this.p4.y = mousePos.y;
    } else if (dragContext.part == 8) {
      this.p1.x = mousePos.x;
      this.p3.x = mousePos.x;
    } else if (dragContext.part == 0) {
      const mousePosSnapped = shift ? mouse.getPosSnappedToDirection(dragContext.mousePos0, [{ x: 1, y: 0 }, { x: 0, y: 1 }], dragContext.snapContext) : mouse.getPosSnappedToGrid();
      const mouseDiffX = dragContext.mousePos1.x - mousePosSnapped.x;
      const mouseDiffY = dragContext.mousePos1.y - mousePosSnapped.y;
      this.p1.x -= mouseDiffX;
      this.p1.y -= mouseDiffY;
      this.p2.x -= mouseDiffX;
      this.p2.y -= mouseDiffY;
      this.p3.x -= mouseDiffX;
      this.p3.y -= mouseDiffY;
      this.p4.x -= mouseDiffX;
      this.p4.y -= mouseDiffY;
      dragContext.mousePos1 = mousePosSnapped;
    }
  }
};

export default CropBox;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-App.html">App</a></li><li><a href="module-CanvasContainer.html">CanvasContainer</a></li><li><a href="module-ColorModeModal.html">ColorModeModal</a></li><li><a href="module-ColorPicker.html">ColorPicker</a></li><li><a href="module-DashPicker.html">DashPicker</a></li><li><a href="module-FileBar.html">FileBar</a></li><li><a href="module-FillControl.html">FillControl</a></li><li><a href="module-FontPicker.html">FontPicker</a></li><li><a href="module-Footer.html">Footer</a></li><li><a href="module-LanguageModal.html">LanguageModal</a></li><li><a href="module-LayoutAidsBar.html">LayoutAidsBar</a></li><li><a href="module-ModuleModal.html">ModuleModal</a></li><li><a href="module-ModuleTools.html">ModuleTools</a></li><li><a href="module-MoreToolsCollapsible.html">MoreToolsCollapsible</a></li><li><a href="module-NumberControl.html">NumberControl</a></li><li><a href="module-ObjBar.html">ObjBar</a></li><li><a href="module-PointControl.html">PointControl</a></li><li><a href="module-PopupSelectControl.html">PopupSelectControl</a></li><li><a href="module-RayDensityBar.html">RayDensityBar</a></li><li><a href="module-SaveModal.html">SaveModal</a></li><li><a href="module-SettingsBar.html">SettingsBar</a></li><li><a href="module-SettingsList.html">SettingsList</a></li><li><a href="module-SettingsWarning.html">SettingsWarning</a></li><li><a href="module-Sidebar.html">Sidebar</a></li><li><a href="module-SimulatorControls.html">SimulatorControls</a></li><li><a href="module-SizePicker.html">SizePicker</a></li><li><a href="module-StatusArea.html">StatusArea</a></li><li><a href="module-StrokeControl.html">StrokeControl</a></li><li><a href="module-TextControl.html">TextControl</a></li><li><a href="module-TextInput.html">TextInput</a></li><li><a href="module-ThemeModal.html">ThemeModal</a></li><li><a href="module-ThemeOptionsList.html">ThemeOptionsList</a></li><li><a href="module-ToggleControl.html">ToggleControl</a></li><li><a href="module-ToolItem.html">ToolItem</a></li><li><a href="module-Toolbar.html">Toolbar</a></li><li><a href="module-ToolsBar.html">ToolsBar</a></li><li><a href="module-ToolsCategory.html">ToolsCategory</a></li><li><a href="module-ToolsList.html">ToolsList</a></li><li><a href="module-ViewBar.html">ViewBar</a></li><li><a href="module-WelcomeMessage.html">WelcomeMessage</a></li><li><a href="module-ZoomControl.html">ZoomControl</a></li><li><a href="module-app_.html">app</a></li></ul><h3>Namespaces</h3><ul><li><a href="geometry.html">geometry</a></li><li><a href="sceneObjs.html">sceneObjs</a></li></ul><h3>Classes</h3><ul><li><a href="BaseFilter.html">BaseFilter</a></li><li><a href="BaseGlass.html">BaseGlass</a></li><li><a href="BaseGrinGlass.html">BaseGrinGlass</a></li><li><a href="BaseSceneObj.html">BaseSceneObj</a></li><li><a href="CanvasRenderer.html">CanvasRenderer</a></li><li><a href="Editor.html">Editor</a></li><li><a href="FloatColorRenderer.html">FloatColorRenderer</a></li><li><a href="JsonEditorService.html">JsonEditorService</a></li><li><a href="Mouse.html">Mouse</a></li><li><a href="ObjBar.html">ObjBar</a></li><li><a href="Scene.html">Scene</a></li><li><a href="Simulator.html">Simulator</a></li><li><a href="sceneObjs.AngleSource.html">AngleSource</a></li><li><a href="sceneObjs.Aperture.html">Aperture</a></li><li><a href="sceneObjs.ArcMirror.html">ArcMirror</a></li><li><a href="sceneObjs.BaseCustomSurface.html">BaseCustomSurface</a></li><li><a href="sceneObjs.Beam.html">Beam</a></li><li><a href="sceneObjs.BeamSplitter.html">BeamSplitter</a></li><li><a href="sceneObjs.Blocker.html">Blocker</a></li><li><a href="sceneObjs.CircleBlocker.html">CircleBlocker</a></li><li><a href="sceneObjs.CircleGlass.html">CircleGlass</a></li><li><a href="sceneObjs.CircleGrinGlass.html">CircleGrinGlass</a></li><li><a href="sceneObjs.ConcaveDiffractionGrating.html">ConcaveDiffractionGrating</a></li><li><a href="sceneObjs.CropBox.html">CropBox</a></li><li><a href="sceneObjs.CurveGlass.html">CurveGlass</a></li><li><a href="sceneObjs.CurveGrinGlass.html">CurveGrinGlass</a></li><li><a href="sceneObjs.CustomArcSurface.html">CustomArcSurface</a></li><li><a href="sceneObjs.CustomGlass.html">CustomGlass</a></li><li><a href="sceneObjs.CustomMirror.html">CustomMirror</a></li><li><a href="sceneObjs.CustomParamSurface.html">CustomParamSurface</a></li><li><a href="sceneObjs.CustomSurface.html">CustomSurface</a></li><li><a href="sceneObjs.Detector.html">Detector</a></li><li><a href="sceneObjs.DiffractionGrating.html">DiffractionGrating</a></li><li><a href="sceneObjs.Drawing.html">Drawing</a></li><li><a href="sceneObjs.Glass.html">Glass</a></li><li><a href="sceneObjs.GrinGlass.html">GrinGlass</a></li><li><a href="sceneObjs.Handle.html">Handle</a></li><li><a href="sceneObjs.IdealLens.html">IdealLens</a></li><li><a href="sceneObjs.IdealMirror.html">IdealMirror</a></li><li><a href="sceneObjs.LineArrow.html">LineArrow</a></li><li><a href="sceneObjs.Mirror.html">Mirror</a></li><li><a href="sceneObjs.ModuleObj.html">ModuleObj</a></li><li><a href="sceneObjs.ParabolicMirror.html">ParabolicMirror</a></li><li><a href="sceneObjs.ParamGlass.html">ParamGlass</a></li><li><a href="sceneObjs.ParamGrinGlass.html">ParamGrinGlass</a></li><li><a href="sceneObjs.ParamMirror.html">ParamMirror</a></li><li><a href="sceneObjs.PlaneGlass.html">PlaneGlass</a></li><li><a href="sceneObjs.PointSource.html">PointSource</a></li><li><a href="sceneObjs.Protractor.html">Protractor</a></li><li><a href="sceneObjs.Ruler.html">Ruler</a></li><li><a href="sceneObjs.SingleRay.html">SingleRay</a></li><li><a href="sceneObjs.SphericalLens.html">SphericalLens</a></li><li><a href="sceneObjs.TextLabel.html">TextLabel</a></li></ul><h3>Events</h3><ul><li><a href="Editor.html#event:mouseCoordinateChange">mouseCoordinateChange</a></li><li><a href="Editor.html#event:newAction">newAction</a></li><li><a href="Editor.html#event:newUndoPoint">newUndoPoint</a></li><li><a href="Editor.html#event:positioningEnd">positioningEnd</a></li><li><a href="Editor.html#event:positioningStart">positioningStart</a></li><li><a href="Editor.html#event:redo">redo</a></li><li><a href="Editor.html#event:requestPositioningComfirm">requestPositioningComfirm</a></li><li><a href="Editor.html#event:scaleChange">scaleChange</a></li><li><a href="Editor.html#event:sceneLoaded">sceneLoaded</a></li><li><a href="Editor.html#event:selectionChange">selectionChange</a></li><li><a href="Editor.html#event:undo">undo</a></li><li><a href="ObjBar.html#event:edit">edit</a></li><li><a href="ObjBar.html#event:editEnd">editEnd</a></li><li><a href="ObjBar.html#event:requestUpdate">requestUpdate</a></li><li><a href="ObjBar.html#event:showAdvancedEnabled">showAdvancedEnabled</a></li><li><a href="Simulator.html#event:lightLayerSyncChange">lightLayerSyncChange</a></li><li><a href="Simulator.html#event:simulationComplete">simulationComplete</a></li><li><a href="Simulator.html#event:simulationPause">simulationPause</a></li><li><a href="Simulator.html#event:simulationStart">simulationStart</a></li><li><a href="Simulator.html#event:simulationStop">simulationStop</a></li><li><a href="Simulator.html#event:update">update</a></li><li><a href="global.html#event:requestUpdateErrorAndWarning">requestUpdateErrorAndWarning</a></li><li><a href="global.html#event:webglContextLost">webglContextLost</a></li></ul><h3>Global</h3><ul><li><a href="global.html#CircleObjMixin">CircleObjMixin</a></li><li><a href="global.html#DATA_VERSION">DATA_VERSION</a></li><li><a href="global.html#LineObjMixin">LineObjMixin</a></li><li><a href="global.html#ParamCurveObjMixin">ParamCurveObjMixin</a></li><li><a href="global.html#checkRayIntersectsShape">checkRayIntersectsShape</a></li><li><a href="global.html#countIntersections">countIntersections</a></li><li><a href="global.html#deepEqual">deepEqual</a></li><li><a href="global.html#distancePointToSegment">distancePointToSegment</a></li><li><a href="global.html#drawPath">drawPath</a></li><li><a href="global.html#extractNonDefaults">extractNonDefaults</a></li><li><a href="global.html#getRayIntersections">getRayIntersections</a></li><li><a href="global.html#initPath">initPath</a></li><li><a href="global.html#isClosed">isClosed</a></li><li><a href="global.html#isInside">isInside</a></li><li><a href="global.html#isOnBoundary">isOnBoundary</a></li><li><a href="global.html#isOutside">isOutside</a></li><li><a href="global.html#isPositivelyOriented">isPositivelyOriented</a></li><li><a href="global.html#mergeWithDefaults">mergeWithDefaults</a></li><li><a href="global.html#populateObjBarShape">populateObjBarShape</a></li><li><a href="global.html#setViewportSize">setViewportSize</a></li><li><a href="global.html#toJSON">toJSON</a></li><li><a href="global.html#usePreferencesStore">usePreferencesStore</a></li><li><a href="global.html#useSceneStore">useSceneStore</a></li><li><a href="global.html#useStatus">useStatus</a></li><li><a href="global.html#useStatusStore">useStatusStore</a></li><li><a href="global.html#useThemeStore">useThemeStore</a></li><li><a href="global.html#vTooltipPopover">vTooltipPopover</a></li><li><a href="global.html#validateNestedKeys">validateNestedKeys</a></li><li><a href="global.html#versionUpdate">versionUpdate</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
